<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <meta name="darkreader-lock">
        <title>CBP Data App</title>
        <link rel="icon" type="image/svg+xml" href="cbp-logo-white-32x32.png" />
        <link rel="stylesheet" href="reset.css">
        <link rel="stylesheet" href="main.css">
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script type="module" src="theme.js"></script>
    </head>
    <body>
        <div class="theme-switcher">
            <button class="theme-toggle" id="themeToggle" title="Toggle theme">
                ðŸŒ™
            </button>
        </div>
        <main class="flex-col">
            <h1>
                <svg  height="100" version="1.1" viewBox="0 0 12842 2564.3" xmlns="http://www.w3.org/2000/svg">
                     <defs>
                      <style>.cls-1{fill:var(--txt);}.cls-2{fill:none;stroke:var(--txt);stroke-miterlimit:10;stroke-width:89px;}</style>
                     </defs>
                     <polygon class="cls-2" transform="translate(-.0027399 -.0055529)" points="846.91 2063 2904.1 2063 2605.6 2519.8 589.54 2515.2"/>
                     <polygon class="cls-2" transform="translate(-.0027399 -.0055529)" points="1237.6 45.8 1797 55.07 2829.9 1823.6 2261.9 1823.6"/>
                     <polygon class="cls-2" transform="translate(-.0027399 -.0055529)" points="51.62 2020.1 1079.9 238.82 1342 707.77 322.9 2473.4"/>
                     <polygon class="cls-2" transform="translate(-.0027399 -.0055529)" points="1249.4 1397 1009.8 1813.2 1488.9 1813.2 1968 1813.2 1728.4 1397 1488.9 980.92"/>
                     <path class="cls-1" d="m3260.6 1497.6c0-38.39 6.75-76.64 20.25-114.75 13.5-38.1 33.3-72.29 59.4-102.6 26.1-30.29 58.05-54.75 95.85-73.35 37.8-18.59 80.69-27.9 128.7-27.9 57 0 105.89 12.91 146.7 38.7 40.8 25.8 71.1 59.4 90.9 100.8l-63.9 41.4c-9.6-20.39-21.15-37.49-34.65-51.3-13.5-13.79-28.21-24.89-44.1-33.3-15.9-8.4-32.26-14.4-49.05-18-16.8-3.6-33.3-5.4-49.5-5.4-35.41 0-66.75 7.35-94.05 22.05-27.31 14.71-50.26 33.91-68.85 57.6-18.6 23.71-32.55 50.4-41.85 80.1-9.31 29.7-13.95 59.55-13.95 89.55 0 33.61 5.54 65.56 16.65 95.85 11.1 30.3 26.55 57.15 46.35 80.55s43.2 42 70.2 55.8c27 13.81 56.39 20.7 88.2 20.7 16.79 0 34.05-2.1 51.75-6.3 17.69-4.19 34.65-10.94 50.85-20.25 16.2-9.3 31.35-21 45.45-35.1 14.09-14.09 25.65-31.05 34.65-50.85l67.5 36.9c-10.21 24-24.45 45.15-42.75 63.45-18.31 18.31-39.01 33.75-62.1 46.35-23.1 12.6-47.56 22.2-73.35 28.8-25.8 6.6-51 9.9-75.6 9.9-43.8 0-84.01-9.59-120.6-28.8-36.6-19.2-68.26-44.24-94.95-75.15-26.7-30.9-47.4-66-62.1-105.3-14.71-39.29-22.05-79.34-22.05-120.15z"/>
                     <path class="cls-1" d="m4310.9 1821.6h-79.2v-262.8c0-48.6-8.41-84.74-25.2-108.45-16.8-23.7-41.4-35.55-73.8-35.55-15.61 0-31.21 3.15-46.8 9.45-15.61 6.3-30.15 14.85-43.65 25.65s-25.51 23.71-36 38.7c-10.5 15-18.45 31.5-23.85 49.5v283.5h-79.2v-657h79.2v288c18.59-34.2 43.79-60.89 75.6-80.1 31.79-19.2 66.6-28.8 104.4-28.8 27.59 0 50.99 5.11 70.2 15.3 19.2 10.21 34.5 24 45.9 41.4 11.39 17.41 19.65 38.25 24.75 62.55 5.09 24.3 7.65 50.26 7.65 77.85z"/>
                     <path class="cls-1" d="m4682.6 1421.1c-39.6 1.21-74.56 11.4-104.85 30.6-30.3 19.21-51.75 45.9-64.35 80.1v289.8h-79.2v-469.8h73.8v108.9c16.2-32.4 37.49-58.64 63.9-78.75 26.4-20.09 54.59-31.34 84.6-33.75h15.3c4.19 0 7.79 0.31 10.8 0.9z"/>
                     <path class="cls-1" d="m4955.3 1830.6c-35.41 0-67.65-6.61-96.75-19.8-29.11-13.19-54-30.9-74.7-53.1-20.7-22.19-36.76-48-48.15-77.4-11.4-29.39-17.1-60.3-17.1-92.7s5.85-64.2 17.55-93.6c11.7-29.39 27.9-55.2 48.6-77.4 20.7-22.19 45.59-39.9 74.7-53.1 29.1-13.19 61.04-19.8 95.85-19.8s66.9 6.61 96.3 19.8c29.39 13.2 54.45 30.91 75.15 53.1 20.7 22.21 36.9 48.01 48.6 77.4 11.7 29.4 17.55 60.61 17.55 93.6s-5.71 63.31-17.1 92.7c-11.4 29.4-27.6 55.21-48.6 77.4-21.01 22.21-46.05 39.91-75.15 53.1-29.11 13.19-61.35 19.8-96.75 19.8zm-155.7-242.1c0 24.61 4.05 47.4 12.15 68.4 8.1 21.01 19.2 39.3 33.3 54.9 14.09 15.61 30.6 27.9 49.5 36.9s39.15 13.5 60.75 13.5 41.85-4.5 60.75-13.5 35.55-21.45 49.95-37.35c14.4-15.89 25.65-34.5 33.75-55.8 8.1-21.29 12.15-44.24 12.15-68.85s-4.05-46.64-12.15-67.95c-8.1-21.29-19.35-39.9-33.75-55.8-14.4-15.89-31.05-28.35-49.95-37.35s-39.15-13.5-60.75-13.5-41.85 4.65-60.75 13.95c-18.9 9.31-35.41 21.91-49.5 37.8-14.1 15.9-25.2 34.51-33.3 55.8-8.1 21.3-12.15 44.25-12.15 68.85z"/>
                     <path class="cls-1" d="m5997.5 1821.6h-79.2v-262.8c0-49.19-7.96-85.5-23.85-108.9-15.91-23.4-39.46-35.1-70.65-35.1s-61.35 11.56-86.85 34.65c-25.51 23.11-43.65 52.96-54.45 89.55v282.6h-79.2v-262.8c0-50.4-7.8-86.99-23.4-109.8-15.61-22.8-39.01-34.2-70.2-34.2s-60.61 11.25-86.4 33.75c-25.8 22.5-44.1 52.35-54.9 89.55v283.5h-79.2v-469.8h72v100.8c19.2-34.79 44.1-61.65 74.7-80.55s65.1-28.35 103.5-28.35 70.95 10.66 94.05 31.95c23.09 21.3 37.35 48.75 42.75 82.35 41.99-76.19 101.7-114.3 179.1-114.3 27 0 49.64 4.95 67.95 14.85 18.29 9.9 32.85 23.71 43.65 41.4 10.8 17.71 18.59 38.56 23.4 62.55 4.79 24 7.2 50.1 7.2 78.3z"/>
                     <path class="cls-1" d="m6328.7 1830.6c-35.41 0-67.81-6.46-97.2-19.35-29.4-12.9-54.6-30.45-75.6-52.65-21.01-22.19-37.35-48.15-49.05-77.85s-17.55-61.05-17.55-94.05 5.85-64.2 17.55-93.6c11.7-29.39 28.2-55.2 49.5-77.4 21.29-22.19 46.65-39.74 76.05-52.65 29.39-12.9 61.79-19.35 97.2-19.35s67.64 6.61 96.75 19.8c29.09 13.2 53.84 30.75 74.25 52.65 20.39 21.91 36.14 47.41 47.25 76.5 11.09 29.11 16.65 59.26 16.65 90.45 0 6.61-0.15 12.6-0.45 18-0.31 5.4-0.76 9.6-1.35 12.6h-389.7c1.8 23.4 7.2 44.71 16.2 63.9 9 19.21 20.7 35.71 35.1 49.5 14.4 13.81 30.74 24.61 49.05 32.4 18.29 7.8 37.65 11.7 58.05 11.7 14.4 0 28.49-1.94 42.3-5.85 13.8-3.9 26.69-9.14 38.7-15.75 12-6.6 22.64-14.7 31.95-24.3 9.29-9.59 16.34-20.39 21.15-32.4l68.4 18.9c-7.8 17.41-18.45 33.3-31.95 47.7s-29.11 26.86-46.8 37.35c-17.71 10.5-37.35 18.76-58.95 24.75s-44.1 9-67.5 9zm161.1-275.4c-1.8-22.19-7.36-42.75-16.65-61.65-9.31-18.9-21.01-34.95-35.1-48.15-14.11-13.19-30.46-23.54-49.05-31.05-18.6-7.5-38.4-11.25-59.4-11.25s-40.81 3.75-59.4 11.25c-18.6 7.51-34.96 18-49.05 31.5-14.1 13.5-25.51 29.56-34.2 48.15-8.7 18.6-13.95 39.01-15.75 61.2z"/>
                     <path class="cls-1" d="m6893.8 1830.6c-36.6 0-69.9-9-99.9-27-30.01-18-53.71-41.4-71.1-70.2v88.2h-70.2v-657h79.2v280.8c19.8-30.6 44.1-55.2 72.9-73.8 28.8-18.59 62.4-27.9 100.8-27.9 32.4 0 61.5 6.91 87.3 20.7 25.79 13.81 47.84 31.95 66.15 54.45 18.29 22.5 32.4 48.6 42.3 78.3s14.85 60.16 14.85 91.35c0 33-5.71 64.21-17.1 93.6-11.4 29.4-27 55.05-46.8 76.95-19.8 21.91-43.35 39.3-70.65 52.2-27.31 12.89-56.56 19.35-87.75 19.35zm-19.8-68.4c23.4 0 45-4.79 64.8-14.4 19.8-9.59 36.9-22.5 51.3-38.7s25.5-34.65 33.3-55.35c7.79-20.7 11.7-42.44 11.7-65.25s-3.75-44.85-11.25-66.15c-7.51-21.29-18-40.05-31.5-56.25s-29.7-29.25-48.6-39.15-39.75-14.85-62.55-14.85c-16.8 0-32.71 3.01-47.7 9-15 6-28.95 13.95-41.85 23.85-12.91 9.9-24.3 21.46-34.2 34.65-9.9 13.21-18.45 27.31-25.65 42.3v135.9c3 15 9.45 28.8 19.35 41.4s21.6 23.55 35.1 32.85c13.5 9.31 27.9 16.65 43.2 22.05s30.15 8.1 44.55 8.1z"/>
                     <path class="cls-1" d="m7418.5 1830.6c-35.41 0-67.65-6.61-96.75-19.8-29.11-13.19-54-30.9-74.7-53.1-20.7-22.19-36.76-48-48.15-77.4-11.4-29.39-17.1-60.3-17.1-92.7s5.85-64.2 17.55-93.6c11.7-29.39 27.9-55.2 48.6-77.4 20.7-22.19 45.59-39.9 74.7-53.1 29.1-13.19 61.04-19.8 95.85-19.8s66.9 6.61 96.3 19.8c29.39 13.2 54.45 30.91 75.15 53.1 20.7 22.21 36.9 48.01 48.6 77.4 11.7 29.4 17.55 60.61 17.55 93.6s-5.71 63.31-17.1 92.7c-11.4 29.4-27.6 55.21-48.6 77.4-21.01 22.21-46.05 39.91-75.15 53.1-29.11 13.19-61.35 19.8-96.75 19.8zm-155.7-242.1c0 24.61 4.05 47.4 12.15 68.4 8.1 21.01 19.2 39.3 33.3 54.9 14.09 15.61 30.6 27.9 49.5 36.9s39.15 13.5 60.75 13.5 41.85-4.5 60.75-13.5 35.55-21.45 49.95-37.35c14.4-15.89 25.65-34.5 33.75-55.8 8.1-21.29 12.15-44.24 12.15-68.85s-4.05-46.64-12.15-67.95c-8.1-21.29-19.35-39.9-33.75-55.8-14.4-15.89-31.05-28.35-49.95-37.35s-39.15-13.5-60.75-13.5-41.85 4.65-60.75 13.95c-18.9 9.31-35.41 21.91-49.5 37.8-14.1 15.9-25.2 34.51-33.3 55.8-8.1 21.3-12.15 44.25-12.15 68.85z"/>
                     <path class="cls-1" d="m7957.6 1830.6c-35.41 0-67.65-6.61-96.75-19.8-29.11-13.19-54-30.9-74.7-53.1-20.7-22.19-36.76-48-48.15-77.4-11.4-29.39-17.1-60.3-17.1-92.7s5.85-64.2 17.55-93.6c11.7-29.39 27.9-55.2 48.6-77.4 20.7-22.19 45.59-39.9 74.7-53.1 29.1-13.19 61.04-19.8 95.85-19.8s66.9 6.61 96.3 19.8c29.39 13.2 54.45 30.91 75.15 53.1 20.7 22.21 36.9 48.01 48.6 77.4 11.7 29.4 17.55 60.61 17.55 93.6s-5.71 63.31-17.1 92.7c-11.4 29.4-27.6 55.21-48.6 77.4-21.01 22.21-46.05 39.91-75.15 53.1-29.11 13.19-61.35 19.8-96.75 19.8zm-155.7-242.1c0 24.61 4.05 47.4 12.15 68.4 8.1 21.01 19.2 39.3 33.3 54.9 14.09 15.61 30.6 27.9 49.5 36.9s39.15 13.5 60.75 13.5 41.85-4.5 60.75-13.5 35.55-21.45 49.95-37.35c14.4-15.89 25.65-34.5 33.75-55.8 8.1-21.29 12.15-44.24 12.15-68.85s-4.05-46.64-12.15-67.95c-8.1-21.29-19.35-39.9-33.75-55.8-14.4-15.89-31.05-28.35-49.95-37.35s-39.15-13.5-60.75-13.5-41.85 4.65-60.75 13.95c-18.9 9.31-35.41 21.91-49.5 37.8-14.1 15.9-25.2 34.51-33.3 55.8-8.1 21.3-12.15 44.25-12.15 68.85z"/>
                     <path class="cls-1" d="m8622.7 1821.6-162-229.5-90 84.6v144.9h-79.2v-657h79.2v432l241.2-243.9h87.3l-187.2 194.4 196.2 274.5z"/>
                     <path class="cls-1" d="m8789.2 1821.6v-639h266.4c28.2 0 54.14 5.85 77.85 17.55 23.7 11.7 44.1 27.31 61.2 46.8 17.1 19.5 30.45 41.4 40.05 65.7 9.59 24.3 14.4 49.05 14.4 74.25s-4.5 51.91-13.5 76.5c-9 24.61-21.75 46.5-38.25 65.7-16.51 19.21-36.31 34.51-59.4 45.9-23.1 11.4-48.75 17.1-76.95 17.1h-190.8v229.5zm81-301.5h186.3c16.79 0 31.95-3.45 45.45-10.35 13.5-6.89 25.04-16.5 34.65-28.8 9.59-12.29 17.1-26.55 22.5-42.75s8.1-33.3 8.1-51.3-3.15-36-9.45-52.2-14.71-30.29-25.2-42.3c-10.5-12-22.81-21.29-36.9-27.9-14.1-6.6-28.96-9.9-44.55-9.9h-180.9z"/>
                     <path class="cls-1" d="m9452.5 1830.6c-22.21 0-42.9-3.75-62.1-11.25-19.21-7.5-35.86-17.85-49.95-31.05-14.1-13.19-25.2-28.65-33.3-46.35-8.1-17.69-12.15-37.04-12.15-58.05s4.79-41.25 14.4-58.95c9.59-17.69 23.25-32.85 40.95-45.45 17.69-12.6 38.7-22.5 63-29.7s50.85-10.8 79.65-10.8c22.79 0 45.9 2.11 69.3 6.3 23.4 4.2 44.1 9.9 62.1 17.1v-37.8c0-38.39-10.8-68.54-32.4-90.45-21.6-21.9-52.2-32.85-91.8-32.85-47.41 0-97.2 18.31-149.4 54.9l-26.1-51.3c60.59-40.79 121.5-61.2 182.7-61.2s109.94 16.51 144.45 49.5c34.5 33 51.75 79.51 51.75 139.5v191.7c0 18.6 8.4 28.21 25.2 28.8v68.4c-8.41 1.2-15.3 2.1-20.7 2.7-5.4 0.59-11.11 0.9-17.1 0.9-15.61 0-28.05-4.64-37.35-13.95-9.31-9.3-14.85-20.55-16.65-33.75l-1.8-33.3c-21.01 28.21-47.56 49.66-79.65 64.35-32.1 14.7-66.46 22.05-103.05 22.05zm20.7-59.4c28.2 0 54.45-5.25 78.75-15.75 24.3-10.49 42.75-24.44 55.35-41.85 11.39-11.39 17.1-23.09 17.1-35.1v-69.3c-38.41-14.99-78.3-22.5-119.7-22.5s-71.86 8.41-96.75 25.2c-24.91 16.8-37.35 38.7-37.35 65.7 0 13.21 2.55 25.51 7.65 36.9 5.09 11.4 12.29 21.3 21.6 29.7 9.3 8.41 20.25 15 32.85 19.8 12.6 4.81 26.1 7.2 40.5 7.2z"/>
                     <path class="cls-1" d="m10079 1421.1c-39.6 1.21-74.56 11.4-104.85 30.6-30.3 19.21-51.75 45.9-64.35 80.1v289.8h-79.2v-469.8h73.8v108.9c16.2-32.4 37.49-58.64 63.9-78.75 26.4-20.09 54.59-31.34 84.6-33.75h15.3c4.19 0 7.79 0.31 10.8 0.9z"/>
                     <path class="cls-1" d="m10400 1798.2c-4.81 2.41-11.11 5.26-18.9 8.55-7.8 3.3-16.65 6.61-26.55 9.9-9.9 3.3-20.7 5.99-32.4 8.1-11.7 2.09-23.85 3.15-36.45 3.15-28.8 0-53.7-7.95-74.7-23.85-21.01-15.89-31.5-40.64-31.5-74.25v-315.9h-63.9v-62.1h63.9v-156.6h79.2v156.6h105.3v62.1h-105.3v291.6c1.2 17.41 6.89 30.01 17.1 37.8 10.2 7.8 22.19 11.7 36 11.7 15.59 0 29.84-2.55 42.75-7.65 12.9-5.09 21.74-9.14 26.55-12.15z"/>
                     <path class="cls-1" d="m10639 1830.6c-37.8 0-75.01-5.85-111.6-17.55-36.6-11.7-68.1-28.65-94.5-50.85l34.2-53.1c27.59 21.01 55.2 36.76 82.8 47.25 27.59 10.5 56.7 15.75 87.3 15.75 34.2 0 61.34-6.75 81.45-20.25 20.1-13.5 30.15-32.54 30.15-57.15 0-11.39-2.7-21.15-8.1-29.25s-13.5-15.14-24.3-21.15c-10.8-5.99-24.61-11.39-41.4-16.2-16.8-4.79-36.31-9.9-58.5-15.3-28.21-7.2-52.51-14.09-72.9-20.7-20.41-6.6-37.21-14.4-50.4-23.4-13.2-9-22.81-19.8-28.8-32.4-6-12.6-9-28.2-9-46.8 0-23.4 4.64-44.24 13.95-62.55 9.29-18.29 22.05-33.59 38.25-45.9 16.2-12.29 35.24-21.6 57.15-27.9 21.9-6.3 45.45-9.45 70.65-9.45 35.4 0 68.4 5.71 99 17.1 30.6 11.4 56.39 26.41 77.4 45l-36 47.7c-19.8-17.4-42-30.45-66.6-39.15-24.61-8.69-49.81-13.05-75.6-13.05-28.8 0-53.25 6.16-73.35 18.45-20.11 12.3-30.15 31.95-30.15 58.95 0 10.8 1.94 19.8 5.85 27 3.9 7.2 10.35 13.5 19.35 18.9s20.54 10.21 34.65 14.4c14.09 4.2 31.05 8.7 50.85 13.5 31.19 7.2 58.34 14.55 81.45 22.05 23.09 7.51 42.3 16.35 57.6 26.55 15.3 10.21 26.69 22.21 34.2 36 7.5 13.81 11.25 30.6 11.25 50.4 0 43.8-16.8 78.61-50.4 104.4-33.61 25.8-78.9 38.7-135.9 38.7z"/>
                     <path class="cls-1" d="m10912 1821.6v-100.8h66.6v100.8z"/>
                     <path class="cls-1" d="m11069 1585.8c0-32.99 5.7-64.2 17.1-93.6 11.39-29.39 27.59-55.04 48.6-76.95 21-21.9 46.04-39.29 75.15-52.2 29.1-12.9 61.65-19.35 97.65-19.35 46.8 0 87.14 10.35 121.05 31.05 33.89 20.7 59.54 48.46 76.95 83.25l-77.4 24.3c-12.01-22.19-28.8-39.45-50.4-51.75-21.6-12.29-45.6-18.45-72-18.45-21.6 0-42 4.36-61.2 13.05-19.21 8.71-35.71 20.85-49.5 36.45-13.81 15.61-24.75 33.9-32.85 54.9-8.1 21.01-12.15 44.1-12.15 69.3s4.19 47.7 12.6 69.3c8.4 21.6 19.65 40.36 33.75 56.25 14.09 15.9 30.6 28.35 49.5 37.35s39.15 13.5 60.75 13.5c13.79 0 27.45-1.94 40.95-5.85 13.5-3.9 25.79-9.14 36.9-15.75 11.1-6.6 20.84-14.25 29.25-22.95 8.4-8.69 14.4-18.14 18-28.35l77.4 23.4c-7.2 17.41-17.25 33.3-30.15 47.7-12.91 14.4-28.05 26.71-45.45 36.9-17.41 10.21-36.76 18.31-58.05 24.3-21.3 5.99-43.65 9-67.05 9-35.41 0-67.81-6.61-97.2-19.8-29.4-13.19-54.6-30.9-75.6-53.1-21.01-22.19-37.35-48.15-49.05-77.85s-17.55-61.04-17.55-94.05z"/>
                     <path class="cls-1" d="m11800 1830.6c-35.41 0-67.65-6.61-96.75-19.8-29.11-13.19-54-30.9-74.7-53.1-20.7-22.19-36.76-48-48.15-77.4-11.4-29.39-17.1-60.3-17.1-92.7s5.85-64.2 17.55-93.6c11.7-29.39 27.9-55.2 48.6-77.4 20.7-22.19 45.59-39.9 74.7-53.1 29.1-13.19 61.04-19.8 95.85-19.8s66.9 6.61 96.3 19.8c29.39 13.2 54.45 30.91 75.15 53.1 20.7 22.21 36.9 48.01 48.6 77.4 11.7 29.4 17.55 60.61 17.55 93.6s-5.71 63.31-17.1 92.7c-11.4 29.4-27.6 55.21-48.6 77.4-21.01 22.21-46.05 39.91-75.15 53.1-29.11 13.19-61.35 19.8-96.75 19.8zm-155.7-242.1c0 24.61 4.05 47.4 12.15 68.4 8.1 21.01 19.2 39.3 33.3 54.9 14.09 15.61 30.6 27.9 49.5 36.9s39.15 13.5 60.75 13.5 41.85-4.5 60.75-13.5 35.55-21.45 49.95-37.35c14.4-15.89 25.65-34.5 33.75-55.8 8.1-21.29 12.15-44.24 12.15-68.85s-4.05-46.64-12.15-67.95c-8.1-21.29-19.35-39.9-33.75-55.8-14.4-15.89-31.05-28.35-49.95-37.35s-39.15-13.5-60.75-13.5-41.85 4.65-60.75 13.95c-18.9 9.31-35.41 21.91-49.5 37.8-14.1 15.9-25.2 34.51-33.3 55.8-8.1 21.3-12.15 44.25-12.15 68.85z"/>
                     <path class="cls-1" d="m12842 1821.6h-79.2v-262.8c0-49.19-7.96-85.5-23.85-108.9-15.9-23.4-39.46-35.1-70.65-35.1s-61.36 11.56-86.85 34.65c-25.51 23.11-43.65 52.96-54.45 89.55v282.6h-79.2v-262.8c0-50.4-7.8-86.99-23.4-109.8-15.61-22.8-39.01-34.2-70.2-34.2s-60.61 11.25-86.4 33.75c-25.8 22.5-44.1 52.35-54.9 89.55v283.5h-79.2v-469.8h72v100.8c19.2-34.79 44.1-61.65 74.7-80.55s65.1-28.35 103.5-28.35 70.95 10.66 94.05 31.95c23.09 21.3 37.35 48.75 42.75 82.35 41.99-76.19 101.7-114.3 179.1-114.3 27 0 49.64 4.95 67.95 14.85 18.3 9.9 32.85 23.71 43.65 41.4 10.8 17.71 18.59 38.56 23.4 62.55 4.79 24 7.2 50.1 7.2 78.3z"/>
                </svg>
            </h1>
            <div class="container">
            <h1>State Sales Line Chart Analysis</h1>

            <div class="controls">
                <div class="control-section">
                    <label for="itemSelect" class="item-label">Select Item:</label>
                    <select id="itemSelect" onchange="onItemSelect()">
                        <option value="">Select an item...</option>
                    </select>
                </div>
                <button class="toggle-btn" id="toggle-24" onclick="toggleLine('line24')">24-Month Trend</button>
                <button class="toggle-btn" id="toggle-12" onclick="toggleLine('line12')">12-Month Trend</button>
                <button class="toggle-btn" id="toggle-6" onclick="toggleLine('line6')">6-Month Trend</button>
                <button class="toggle-btn" id="toggle-3" onclick="toggleLine('line3')">Custom Trend</button>
                <button class="toggle-btn" onclick="resetView()">Show All</button>
                <div class="custom-controls">
                    <h3 class="custom-controls-title">Custom Trend Controls:</h3>
                    <div class="controls-container">
                        <div class="control-group">
                            <label for="interceptSlider" class="control-label">
                                Starting Value (Intercept): <span id="interceptValue">0</span>
                            </label>
                            <input type="range" id="interceptSlider" min="-1000" max="1000" value="0" step="10"
                                   oninput="updateCustomLine()" class="range-input">
                            <div class="range-info">
                                Range: <span id="interceptRange">-1000 to 1000</span>
                            </div>
                        </div>
                        <div class="control-group">
                            <label for="slopeSlider" class="control-label">
                                Trend Direction (Slope): <span id="slopeValue">0</span>/month
                            </label>
                            <input type="range" id="slopeSlider" min="-50" max="50" value="0" step="1"
                                   oninput="updateCustomLine()" class="range-input">
                            <div class="range-info">
                                Range: <span id="slopeRange">-50 to 50</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- comment -->
            <div id="chart"></div>

            <div class="legend">
                <!-- <div class="legend-item"> -->
                <!--     <div class="legend-line" style="background-color: #e0e0e0;"></div> -->
                <!--     <span class="legend-text">Actual Sales Data</span> -->
                <!-- </div> -->
                <div class="legend-item">
                    <div class="legend-line legend-line-24month"></div>
                    <span class="legend-text">24-Month Trend Line</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line legend-line-12month"></div>
                    <span class="legend-text">12-Month Trend Line</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line legend-line-6month"></div>
                    <span class="legend-text">6-Month Trend Line</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line legend-line-custom"></div>
                    <span class="legend-text">Custom Trend Line</span>
                </div>
            </div>

            <div id="trendStats" class="trend-stats">
                <h3 class="trend-stats-title">Trend Line Statistics:</h3>
                <div id="statsContent" class="stats-content">
                    <!-- Statistics will be populated here -->
                </div>
            </div>

            <div class="tooltip" id="tooltip"></div>
        </div>
        </main>
        <script type="module">
            async function fetchJSONData(){
                try {
                    const response = await fetch('/api/items');
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Failed to fetch data:', error);
                    return null;
                }
            }

            let salesData = [];
            let allItemData = {};

            // Initialize the application
            async function initializeApp() {
                const itemData = await fetchJSONData();
                console.log("itemData", itemData);

                if (itemData) {
                    allItemData = itemData;
                    populateItemDropdown(Object.keys(itemData));

                    // Load first item by default if available
                    const firstKey = Object.keys(itemData)[0];
                    if (firstKey) {
                        loadItemData(firstKey);
                        document.getElementById('itemSelect').value = firstKey;
                    }
                }

                // Initialize slider display values
                document.getElementById('interceptValue').textContent = '0';
                document.getElementById('slopeValue').textContent = '0';
                document.getElementById('interceptRange').textContent = '-1000 to 1000';
                document.getElementById('slopeRange').textContent = '-50 to 50';
            }

            // Populate the dropdown with item keys
            function populateItemDropdown(itemKeys) {
                const select = document.getElementById('itemSelect');
                // Clear existing options except the first one
                select.innerHTML = '<option value="">Select an item...</option>';

                itemKeys.forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key;
                    select.appendChild(option);
                });
            }

            // Handle item selection
            function onItemSelect() {
                const selectedItem = document.getElementById('itemSelect').value;
                if (selectedItem && allItemData[selectedItem]) {
                    loadItemData(selectedItem);
                } else {
                    // Clear the chart if no item is selected
                    salesData = [];
                    d3.select("#chart").selectAll("*").remove();
                }
            }

            // Make functions globally accessible
            window.onItemSelect = onItemSelect;
            window.toggleLine = toggleLine;
            window.resetView = resetView;
            window.updateButtonState = updateButtonState;
            window.updateAllButtonStates = updateAllButtonStates;
            window.updateCustomLine = updateCustomLine;

            // Load data for selected item
            function loadItemData(itemKey) {
                if (allItemData[itemKey]) {
                    console.log("Loading data for:", itemKey);

                    // Process the data
                    salesData = allItemData[itemKey].slice(-25, -1);

                    // Ensure dates are properly converted
                    salesData.forEach(d => {
                        if (typeof d.date === 'string') {
                            d.date = new Date(d.date);
                        }
                    });

                    console.log("Processed salesData length:", salesData.length);

                    // Reset line visibility to show all lines
                    lineVisibility = {
                        line24: true,
                        line12: true,
                        line6: true,
                        line3: true
                    };

                    // Update slider ranges based on new data
                    updateSliderRanges();

                    // Update visualization immediately
                    createVisualization(salesData);
                    updateAllButtonStates();
                }
            }

            // Start the application
            initializeApp();

            // Helper function to get CSS variable values (globally accessible)
            window.getCSSVariable = function(variableName) {
                return getComputedStyle(document.documentElement).getPropertyValue(variableName).trim();
            };

            // Function to update chart colors on theme change
            function updateChartColors() {
                if (salesData.length === 0) return;
                // Update bar colors
                d3.selectAll('.bar')
                    .attr('fill', window.getCSSVariable('--chart-bar-fill'));
                // Update axis text colors
                d3.selectAll('.axis text')
                    .style('fill', window.getCSSVariable('--chart-axis-text'));
                // Update axis label colors
                d3.selectAll('text[transform*="rotate"]')
                    .style('fill', window.getCSSVariable('--chart-axis-text'));
                d3.selectAll('text[transform*="translate"]')
                    .style('fill', window.getCSSVariable('--chart-axis-text'));
                // Update projection line colors
                d3.selectAll('.projection-line')
                    .style('stroke', function(d, i) {
                        const lineKeys = Object.keys(lineVisibility);
                        const key = lineKeys[i];
                        if (key === 'line24') return window.getCSSVariable('--trend-24month');
                        if (key === 'line12') return window.getCSSVariable('--trend-12month');
                        if (key === 'line6') return window.getCSSVariable('--trend-6month');
                        if (key === 'line3') return window.getCSSVariable('--trend-custom');
                        return window.getCSSVariable('--chart-stroke');
                    });
                // Regenerate projections with new colors and update visualization
                const newProjections = generateProjections(salesData);
                updateVisualization();
            }

            // Initialize theme manager
            import('./theme.js').then(({ themeManager }) => {
                themeManager.setChartUpdateCallback(updateChartColors);
            });

            // Global variables for line visibility
            let lineVisibility = {
                line24: true,
                line12: true,
                line6: true,
                line3: true
            };

            // Custom line parameters
            let customLineParams = {
                intercept: 0,
                slope: 0
            };

            // Generate line chart data
            function generateLineData(salesData) {
                const lines = {};

                // 24-month line
                lines.line24 = {
                    data: salesData,
                    color: window.getCSSVariable('--trend-24month'),
                    label: '24-month Sales'
                };

                // 12-month line
                lines.line12 = {
                    data: salesData.slice(-12),
                    color: window.getCSSVariable('--trend-12month'),
                    label: '12-month Sales'
                };

                // 6-month line
                lines.line6 = {
                    data: salesData.slice(-6),
                    color: window.getCSSVariable('--trend-6month'),
                    label: '6-month Sales'
                };

                // Custom line (placeholder for future customization)
                lines.line3 = {
                    data: salesData.slice(-3),
                    color: window.getCSSVariable('--trend-custom'),
                    label: 'Custom Sales'
                };

                return lines;
            }

            // Toggle line visibility
            function toggleLine(lineId) {
                lineVisibility[lineId] = !lineVisibility[lineId];
                updateVisualization();
                updateButtonState(lineId);
            }

            // Reset view to show all lines
            function resetView() {
                Object.keys(lineVisibility).forEach(key => {
                    lineVisibility[key] = true;
                });
                updateVisualization();
                updateAllButtonStates();
            }

            // Update button states
            function updateButtonState(lineId) {
                const button = document.getElementById(`toggle-${lineId.replace('line', '')}`);
                if (lineVisibility[lineId]) {
                    button.classList.remove('inactive');
                } else {
                    button.classList.add('inactive');
                }
            }

            function updateAllButtonStates() {
                updateButtonState('line24');
                updateButtonState('line12');
                updateButtonState('line6');
                updateButtonState('line3');
            }

            // Update slider ranges based on current data
            function updateSliderRanges() {
                if (!salesData || salesData.length === 0) return;

                // Calculate data statistics
                const salesValues = salesData.map(d => d.sales);
                const minSales = Math.min(...salesValues);
                const maxSales = Math.max(...salesValues);
                const avgSales = salesValues.reduce((a, b) => a + b, 0) / salesValues.length;
                const dataRange = maxSales - minSales;

                // Set intercept range based on data range (Â±2x the data range around average)
                const interceptMin = Math.floor(avgSales - dataRange);
                const interceptMax = Math.ceil(avgSales + dataRange);
                const interceptStep = Math.max(1, Math.floor(dataRange / 100));

                // Set slope range based on data variability (what would be reasonable monthly change)
                const monthlyChangeEstimate = dataRange / salesData.length;
                const slopeMin = Math.floor(-monthlyChangeEstimate * 2);
                const slopeMax = Math.ceil(monthlyChangeEstimate * 2);
                const slopeStep = Math.max(0.1, Math.floor(monthlyChangeEstimate / 20));

                // Update intercept slider
                const interceptSlider = document.getElementById('interceptSlider');
                interceptSlider.min = interceptMin;
                interceptSlider.max = interceptMax;
                interceptSlider.step = interceptStep;

                // Reset to reasonable default (current average)
                interceptSlider.value = Math.round(avgSales);
                customLineParams.intercept = Math.round(avgSales);

                // Update slope slider
                const slopeSlider = document.getElementById('slopeSlider');
                slopeSlider.min = slopeMin;
                slopeSlider.max = slopeMax;
                slopeSlider.step = slopeStep;

                // Reset slope to 0
                slopeSlider.value = 0;
                customLineParams.slope = 0;

                // Update range displays
                document.getElementById('interceptRange').textContent = `${interceptMin} to ${interceptMax}`;
                document.getElementById('slopeRange').textContent = `${slopeMin} to ${slopeMax}`;

                // Update value displays
                document.getElementById('interceptValue').textContent = Math.round(avgSales);
                document.getElementById('slopeValue').textContent = '0';

                console.log('Updated slider ranges:', {
                    intercept: {min: interceptMin, max: interceptMax, step: interceptStep},
                    slope: {min: slopeMin, max: slopeMax, step: slopeStep},
                    dataStats: {min: minSales, max: maxSales, avg: avgSales, range: dataRange}
                });
            }

            // Update trend statistics display
            function updateTrendStats(lines) {
                const statsContent = document.getElementById('statsContent');
                let statsHTML = '';

                Object.keys(lines).forEach(key => {
                    const line = lines[key];
                    const lineInfo = lineVisibility[key];
                    const isVisible = lineInfo ? 'visible' : 'hidden';
                    const opacity = lineInfo ? '1' : '0.5';

                    // Calculate basic stats for the line
                    const salesValues = line.data.map(d => d.sales);
                    const avgSales = salesValues.reduce((a, b) => a + b, 0) / salesValues.length;
                    const minSales = Math.min(...salesValues);
                    const maxSales = Math.max(...salesValues);

                    statsHTML += `
                        <div class="stats-item" style="border-left-color: ${line.color}; opacity: ${opacity};">
                            <div class="stats-item-title" style="color: ${line.color};">
                                ${line.label} (${isVisible})
                            </div>
                            <div class="stats-item-avg">Average Sales: ${avgSales.toFixed(2)}</div>
                            <div class="stats-item-min">Min Sales: ${minSales.toFixed(2)}</div>
                            <div class="stats-item-max">Max Sales: ${maxSales.toFixed(2)}</div>
                        </div>
                    `;
                });

                statsContent.innerHTML = statsHTML;
            }

            // Update custom line parameters and refresh visualization
            function updateCustomLine() {
                console.log('updateCustomLine called');
                const interceptSlider = document.getElementById('interceptSlider');
                const slopeSlider = document.getElementById('slopeSlider');
                const interceptValue = document.getElementById('interceptValue');
                const slopeValue = document.getElementById('slopeValue');

                customLineParams.intercept = parseFloat(interceptSlider.value);
                customLineParams.slope = parseFloat(slopeSlider.value);

                console.log('Updated params:', customLineParams);

                interceptValue.textContent = Math.round(interceptSlider.value);
                slopeValue.textContent = parseFloat(slopeSlider.value).toFixed(1);

                // Only update if we have data loaded
                if (salesData && salesData.length > 0) {
                    console.log('Updating visualization with salesData length:', salesData.length);
                    updateVisualization();
                } else {
                    console.log('No salesData available for update');
                }
            }

            // Main visualization function
            function createVisualization(salesData) {

                // Clear previous chart
                d3.select('#chart').selectAll('*').remove();

                const margin = {top: 20, right: 80, bottom: 60, left: 80};
                const width = 1000 - margin.left - margin.right;
                const height = 400 - margin.top - margin.bottom;

                const svg = d3.select('#chart')
                    .append('svg')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom);

                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                // Scales
                const xScale = d3.scaleTime()
                    .domain([
                        d3.timeMonth.offset(salesData[0].date, -1),
                        d3.timeMonth.offset(salesData[salesData.length - 1].date, 13)
                    ])
                    .range([0, width]);

                const allSalesValues = salesData.map(d => d.sales);
                const projections = generateProjections(salesData);

                // Calculate max projected value for y-scale
                let maxProjectedValue = d3.max(allSalesValues);
                Object.keys(projections).forEach(key => {
                    const proj = projections[key];
                    const futureValue = proj.regression.intercept + proj.regression.slope * 18; // 18 months out
                    maxProjectedValue = Math.max(maxProjectedValue, futureValue);
                });

                const yScale = d3.scaleLinear()
                    .domain([0, maxProjectedValue * 1.1])
                    .range([height, 0]);

                // Add projected area background
                g.append('rect')
                    .attr('class', 'projected-section')
                    .attr('x', xScale(salesData[salesData.length - 1].date))
                    .attr('y', 0)
                    .attr('width',
                        xScale(d3.timeMonth.offset(salesData[salesData.length - 1].date, 12))
                            - xScale(salesData[salesData.length - 1].date))
                    .attr('height', height);

                // Tooltip
                const tooltip = d3.select('#tooltip');

                // Draw bars for actual sales data
                g.selectAll('.bar')
                    .data(salesData)
                    .enter().append('rect')
                    .attr('class', 'bar')
                    .attr('x', d => xScale(d.date))
                    .attr('width', Math.max(1, (width / salesData.length) - 18))
                    .attr('y', d => yScale(d.sales))
                    .attr('height', d => height - yScale(d.sales))
                    .attr('fill', window.getCSSVariable('--chart-bar-fill'))
                    .attr('opacity', 0.7)
                    .on('mouseover', function(event, d) {
                        tooltip.style('opacity', 1)
                            .html(`Date: ${d3.timeFormat('%b %Y')(d.date)}<br/>Sales Qty: ${d.sales.toLocaleString()}`)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        tooltip.style('opacity', 0);
                    });

                // Draw projection lines
                drawProjectionLines(g, projections, salesData, xScale, yScale);

                // Update trend statistics display
                updateTrendStats(projections);

                // Add vertical line to separate actual vs projected
                const currentDate = salesData[salesData.length - 1].date;
                g.append('line')
                    .attr('class', 'current-date-line')
                    .attr('x1', xScale(currentDate))
                    .attr('x2', xScale(currentDate))
                    .attr('y1', 0)
                    .attr('y2', height);

                // Add axes
                g.append('g')
                    .attr('class', 'axis')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat('%b %Y')));

                g.append('g')
                    .attr('class', 'axis')
                    .call(d3.axisLeft(yScale).tickFormat(d => `${d/1000}k`));

                // Add axis labels
                g.append('text')
                    .attr('transform', 'rotate(-90)')
                    .attr('y', 0 - margin.left)
                    .attr('x', 0 - (height / 2))
                    .attr('dy', '1em')
                    .style('text-anchor', 'middle')
                    .style('font-size', '14px')
                    .style('fill', window.getCSSVariable('--chart-axis-text'))
                    .text('Sales Qty');

                g.append('text')
                    .attr('transform', `translate(${width/2}, ${height + margin.bottom - 10})`)
                    .style('text-anchor', 'middle')
                    .style('font-size', '14px')
                    .style('fill', window.getCSSVariable('--chart-axis-text'))
                    .text('Date');
            }
            function drawProjectionLines(g, projections, salesData, xScale, yScale) {
                Object.keys(projections).forEach(key => {
                    if (!lineVisibility[key]) return;

                    const proj = projections[key];
                    const lineData = [];

                    // Generate line points from start index to 12 months in future
                    for (let i = proj.startIndex; i < salesData.length + 12; i++) {
                        const adjustedIndex = i - proj.startIndex;
                        const predictedSales = proj.regression.intercept + proj.regression.slope * adjustedIndex;
                        const date = i < salesData.length
                            ? salesData[i].date
                            : d3.timeMonth.offset(salesData[salesData.length - 1].date, i - salesData.length + 1);

                        lineData.push({
                            date: date,
                            sales: Math.max(0, predictedSales), // Ensure non-negative values
                            isProjected: i >= salesData.length
                        });
                    }

                    // Line generator
                    const line = d3.line()
                        .x(d => xScale(d.date))
                        .y(d => yScale(d.sales));

                    // Draw the line with different styles for actual vs projected
                    const actualData = lineData.filter(d => !d.isProjected);
                    const projectedData = lineData.filter(d => d.isProjected);

                    // Add the last actual point to projected data for continuity
                    if (actualData.length > 0) {
                        projectedData.unshift(actualData[actualData.length - 1]);
                    }

                    // Draw actual portion (solid line)
                    if (actualData.length > 1) {
                        g.append('path')
                            .datum(actualData)
                            .attr('fill', 'none')
                            .attr('stroke', proj.color)
                            .attr('stroke-width', 3)
                            .attr('d', line);
                    }

                    // Draw projected portion (dashed line)
                    if (projectedData.length > 1) {
                        g.append('path')
                            .datum(projectedData)
                            .attr('fill', 'none')
                            .attr('stroke', proj.color)
                            .attr('stroke-width', 3)
                            .attr('stroke-dasharray', '5,5')
                            .attr('d', line);
                    }

                    // Add line label
                    const lastPoint = lineData[lineData.length - 1];
                    g.append('text')
                        .attr('x', xScale(lastPoint.date) + 5)
                        .attr('y', yScale(lastPoint.sales))
                        .attr('fill', proj.color)
                        .attr('font-size', '12px')
                        .attr('font-weight', 'bold')
                        .text(proj.label);
                });
            }


            function updateVisualization() {
                if (salesData.length > 0) {
                    createVisualization(salesData);
                } else {
                    console.log("No data available for visualization yet");
                }
            }

            // Visualization will be initialized by initializeApp after data is loaded
        </script>
    </body>
</html>
